# Matching Engine Documentation

NOTE: Generated by an LLM

## Overview
The Matching Engine is the core component responsible for processing orders, matching trades, and maintaining the order book in the trading system. It handles both limit and market orders, manages trade execution, and maintains trade history.

## Core Components

| Component | Description |
|-----------|-------------|
| OrderBook | Maintains the current state of all orders |
| TxnHistory | Records and stores all executed trades |

## Public Methods

| Method | Parameters | Return Type | Description |
|--------|------------|-------------|-------------|
| `new()` | None | `MatchingEngine` | Creates a new matching engine instance |
| `place_order` | `order: Order` | `Order` | Processes a new order (market or limit) |
| `get_order_book` | `depth: usize` | `(Vec<(Decimal, Decimal)>, Vec<(Decimal, Decimal)>)` | Returns current order book state to specified depth |
| `get_order_status` | `order_id: u64` | `Option<&Order>` | Retrieves status of a specific order |
| `orders_at_price` | `price: Decimal, side: Side` | `VecDeque<Order>` | Returns all orders at a specific price level |
| `best_bid` | None | `Option<Decimal>` | Returns the best bid price |
| `best_ask` | None | `Option<Decimal>` | Returns the best ask price |
| `get_trade_history` | `limit: Option<usize>` | `Vec<Trade>` | Retrieves recent trade history |

## Private Methods

| Method | Purpose | Description |
|--------|---------|-------------|
| `place_limit_order` | Order Processing | Handles placement and matching of limit orders |
| `place_market_order` | Order Processing | Handles placement and matching of market orders |
| `get_best_matching_price` | Price Discovery | Finds the best available matching price for an order |
| `should_match` | Matching Logic | Determines if an order should match at a given price |
| `match_at_price_level` | Trade Execution | Processes matches at a specific price level |
| `update_order_status` | State Management | Updates order status based on fill amount |
| `match_order` | Core Matching | Main matching logic for processing orders |

## Matching Logic Flow

1. Order received via `place_order`
2. Routed to appropriate handler based on order type (market/limit)
3. Matching process begins with `match_order`
4. Continues matching until either:
   - Order is fully filled
   - No more matching prices available
   - Price limit reached (for limit orders)
5. Any remaining quantity is added to the order book (limit orders only)
6. Trades are recorded in history

## Trade Recording
- Trades are collected in a `VecDeque` during matching
- Recorded in batch after matching completes
- Trade history maintained separately from order book